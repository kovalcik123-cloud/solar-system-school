<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Slnečná Sústava 3D (Školská Edícia)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; touch-action: none; }
        #canvas-container { width: 100vw; height: 100vh; display: block; z-index: 1; }
        
        /* --- LOADER --- */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; z-index: 2000; transition: opacity 0.8s; }
        .spinner { width: 50px; height: 50px; border: 4px solid #222; border-top: 4px solid #44aadd; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- GATEKEEPER --- */
        #gatekeeper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a2a44 0%, #000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1500;
        }
        .login-box {
            background: rgba(255, 255, 255, 0.05); padding: 40px; border-radius: 15px;
            border: 1px solid rgba(68, 170, 221, 0.3); backdrop-filter: blur(10px);
            text-align: center; width: 85%; max-width: 350px;
        }
        #gatekeeper input {
            width: 80%; padding: 12px; margin: 20px 0; border-radius: 5px; border: 1px solid #333;
            background: #000; color: #44aadd; text-align: center; font-size: 18px;
        }
        #gatekeeper button {
            padding: 12px 30px; background: #44aadd; border: none; color: white;
            border-radius: 5px; cursor: pointer; text-transform: uppercase; font-weight: bold; width: 100%;
        }

        /* --- PLANET NAVIGATION BAR --- */
        #planet-nav {
            position: fixed; 
            top: 0; left: 0; right: 0; 
            height: calc(60px + env(safe-area-inset-top)); 
            padding-top: env(safe-area-inset-top);
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid #44aadd;
            display: flex; align-items: center;
            overflow-x: auto; white-space: nowrap; 
            z-index: 9999; 
            padding-left: 10px; padding-right: 10px; 
            -ms-overflow-style: none; scrollbar-width: none;
            -webkit-overflow-scrolling: touch; touch-action: pan-x;
        }
        #planet-nav::-webkit-scrollbar { display: none; }
        
        .nav-item {
            display: inline-block; padding: 6px 14px; margin: 0 5px;
            border: 1px solid #44aadd; border-radius: 15px;
            color: #44aadd; background: rgba(68, 170, 221, 0.1);
            cursor: pointer; font-size: 12px; font-weight: bold;
            text-transform: uppercase; flex-shrink: 0;
            transition: all 0.2s;
            margin-top: auto; margin-bottom: 15px; 
        }
        .nav-item:active, .nav-item:hover { background: #44aadd; color: white; transform: scale(1.05); }

        /* --- UI OVERLAYS --- */
        #side-ui { 
            position: absolute; 
            top: 160px; 
            left: 20px; 
            display: flex; flex-direction: column; gap: 15px;
            pointer-events: none; z-index: 10; visibility: hidden;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; font-size: 24px; color: #fff; }
        .subtitle { margin: 5px 0 0 0; font-size: 14px; color: #aaa; max-width: 300px; line-height: 1.4; }

        .button-group { pointer-events: auto; display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .menu-btn { 
            background: rgba(68, 170, 221, 0.15); border: 1px solid #44aadd; color: #44aadd; 
            padding: 10px 18px; border-radius: 4px; cursor: pointer; text-align: left;
            text-transform: uppercase; letter-spacing: 1px; font-size: 11px; width: fit-content;
        }
        .menu-btn:hover { background: rgba(68, 170, 221, 0.8); color: white; }
        
        #pause-btn.active { background: rgba(255, 170, 0, 0.2); border-color: #ffaa00; color: #ffaa00; }

        /* --- CENTERED OVERLAYS --- */
        #quiz-overlay, #info-card {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 320px; background: rgba(10, 20, 35, 0.95); 
            border-radius: 12px; padding: 25px; display: none; backdrop-filter: blur(10px); z-index: 100;
        }
        #quiz-overlay { border: 2px solid #ffaa00; z-index: 200; }
        #info-card { border: 1px solid #44aadd; }
        
        #quiz-question, #quiz-feedback, #quiz-score { text-align: center; }
        #quiz-question { font-size: 18px; margin-bottom: 20px; color: #fff; }
        #quiz-score { color: #44aadd; border-top: 1px solid #333; padding-top: 15px; margin-top: 15px; }
        
        #info-card h2 { margin-top: 0; color: #44aadd; border-bottom: 1px solid #334455; padding-bottom: 10px; margin-bottom: 15px; font-weight: 400; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .label { color: #8899aa; } .value { font-weight: bold; color: #fff; }
        .fact-box { margin-top: 20px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-left: 3px solid #44aadd; border-radius: 0 4px 4px 0; font-style: italic; font-size: 0.9rem; line-height: 1.5; color: #ddeeff; }
        .close-btn { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 24px; color: #556677; transition: color 0.2s; line-height: 1; }

        #results-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center;
            z-index: 1600;
        }
        .results-box {
            background: #1a2a44; border: 2px solid #44aadd; padding: 40px; border-radius: 20px;
            text-align: center; width: 80%; max-width: 400px;
        }
        .grade-text { font-size: 48px; font-weight: bold; color: #ffaa00; margin: 20px 0; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="gatekeeper">
        <div class="login-box">
            <h2 style="color: #44aadd; margin-top:0;">ŠKOLSKÝ PRÍSTUP</h2>
            <p style="color: #888; font-size: 14px;">Zadajte kód od učiteľa</p>
            <input type="text" id="activation-code" placeholder="XXXX-XXXX" maxlength="10">
            <button onclick="checkCode()">VSTÚPIŤ</button>
            <div id="error-msg" style="color:#ff4444; display:none; margin-top:10px;">Neplatný kód</div>
        </div>
    </div>

    <div id="planet-nav" style="display:none;"></div>

    <div id="canvas-container"></div>

    <div id="side-ui">
        <h1>Slnečná Sústava 3D</h1>
        <p class="subtitle">Ťahaním otáčajte • Kolieskom približujte • Kliknutím na planétu zamerajte<br>Pravým tlačidlom ťaháte</p>
        <div class="button-group">
            <button id="pause-btn" class="menu-btn" onclick="toggleOrbit()">Orbity: ZAPNUTÉ</button>
            <button class="menu-btn" onclick="resetCamera()">Resetovať pohľad</button>
            <button class="menu-btn" onclick="startQuiz()">Spustiť Kvíz</button>
        </div>
    </div>

    <div id="quiz-overlay">
        <div id="quiz-question">Načítavam...</div>
        <div id="quiz-feedback"></div>
        <div id="quiz-score"></div>
        <button onclick="stopQuiz()" style="margin-top:15px; width:100%; padding:8px; background:transparent; border:1px solid #ff4444; color:#ff4444; cursor:pointer; border-radius:4px; font-size: 11px;">Ukončiť</button>
    </div>

    <div id="results-screen">
        <div class="results-box">
            <h2 style="margin-top:0; color:#44aadd;">VÝSLEDOK TESTU</h2>
            <div class="grade-text" id="final-score">0 / 8</div>
            <div id="grade-comment" style="margin-bottom: 25px; color:#ccc;"></div>
            <button onclick="stopQuiz()" style="padding: 12px 30px; background:#44aadd; border:none; color:white; border-radius:5px; cursor:pointer; font-weight:bold;">SPÄŤ</button>
        </div>
    </div>

    <div id="info-card">
        <div class="close-btn" onclick="closePopup()">×</div>
        <h2 id="planet-name">Planéta</h2>
        <div class="data-row"><span class="label">Vzdialenosť:</span><span class="value" id="planet-dist"></span></div>
        <div class="data-row"><span class="label">Priemer:</span><span class="value" id="planet-diam"></span></div>
        <div class="data-row"><span class="label">Obežná doba:</span><span class="value" id="planet-orbit"></span></div>
        <div class="data-row"><span class="label">Rotácia:</span><span class="value" id="planet-rotate"></span></div>
        <div class="fact-box" id="planet-fact"></div>
    </div>

    <script>
        // CONFIG: Moons Added!
        const planetData = [
            { name: "Slnko", radius: 20, distance3D: 0, speed: 0, color: 0xffaa00, texture: "sun.jpg", realDist: "0 km", realDiam: "1.39M km", orbit: "N/A", rotation: "27 dní", fact: "Slnko tvorí 99,86% hmotnosti celej sústavy." },
            { name: "Merkúr", radius: 0.8, distance3D: 35, speed: 0.015, color: 0xaaaaaa, type: "rocky", texture: "mercury.jpg", realDist: "57.9M km", realDiam: "4,879 km", orbit: "88 dní", rotation: "59 dní", fact: "Najmenšia planéta, ktorá sa ochladzovaním zmenšuje." },
            { name: "Venuša", radius: 1.9, distance3D: 50, speed: 0.012, color: 0xe3bb76, type: "atmosphere", texture: "venus.jpg", realDist: "108.2M km", realDiam: "12,104 km", orbit: "225 dní", rotation: "243 dní", fact: "Deň na Venuši je dlhší ako jej rok." },
            { 
                name: "Zem", radius: 2, distance3D: 70, speed: 0.010, color: 0x2233ff, type: "earth", texture: "earth.jpg", realDist: "149.6M km", realDiam: "12,742 km", orbit: "365 dní", rotation: "24 hod", fact: "Jediná planéta nepomenovaná po bohovi.",
                moons: [{ name: "Mesiac", radius: 0.5, distance: 4, speed: 0.05, texture: "moon.jpg" }] // ADDED MOON
            },
            { 
                name: "Mars", radius: 1.1, distance3D: 90, speed: 0.008, color: 0xdd4422, type: "rocky", texture: "mars.jpg", realDist: "227.9M km", realDiam: "6,779 km", orbit: "687 dní", rotation: "24.6 hod", fact: "Domov najvyššej sopky Olympus Mons.",
                moons: [{ name: "Phobos", radius: 0.3, distance: 2.5, speed: 0.08, texture: "moon.jpg" }] // REUSED MOON TEXTURE
            },
            { 
                name: "Jupiter", radius: 10, distance3D: 130, speed: 0.005, color: 0xd8ca9d, type: "gas", texture: "jupiter.jpg", realDist: "778.5M km", realDiam: "139,820 km", orbit: "11.9 r", rotation: "9.9 hod", fact: "Najväčšia planéta s obrovskou búrkou.",
                moons: [{ name: "Europa", radius: 0.6, distance: 15, speed: 0.04, texture: "europa.jpg" }] // ADDED EUROPA
            },
            { name: "Saturn", radius: 8.5, distance3D: 180, speed: 0.004, color: 0xcfae76, hasRings: true, type: "gas", texture: "saturn.jpg", realDist: "1.4B km", realDiam: "116,460 km", orbit: "29.5 r", rotation: "10.7 hod", fact: "Prstence sú tvorené prevažne ľadom." },
            { name: "Urán", radius: 4, distance3D: 220, speed: 0.003, color: 0xadd8e6, type: "gas", texture: "uranus.jpg", realDist: "2.9B km", realDiam: "50,724 km", orbit: "84 r", rotation: "17.2 hod", fact: "Rotuje takmer vodorovne." },
            { name: "Neptún", radius: 3.9, distance3D: 260, speed: 0.002, color: 0x3344ff, type: "gas", texture: "neptune.jpg", realDist: "4.5B km", realDiam: "49,244 km", orbit: "165 r", rotation: "16.1 hod", fact: "Najvzdialenejšia planéta od Slnka." }
        ];

        let scene, camera, renderer, controls, raycaster, mouse;
        let planets = [];
        let satellites = []; // Stores all moons
        let isQuizMode = false, quizQueue = [], quizIndex = 0, score = 0, quizTarget = null, isWaiting = false;
        let areOrbitsActive = true; 
        let touchStartX = 0, touchStartY = 0;

        window.addEventListener('load', () => {
            setTimeout(() => {
                const loader = document.getElementById('loader');
                if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 800); }
            }, 500);
        });

        function checkCode() {
            const inputHash = btoa(document.getElementById('activation-code').value.toUpperCase());
            if(inputHash === "TkdWLTIwMjU=" || inputHash === "UkFBQkU=" || inputHash === "VEFLVElL") {
                document.getElementById('gatekeeper').style.display = 'none';
                document.getElementById('side-ui').style.visibility = 'visible';
                document.getElementById('planet-nav').style.display = 'flex';
                init();
            } else { document.getElementById('error-msg').style.display = 'block'; }
        }

        function generateOrganicTexture(data) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            const baseCol = '#' + (data.color || 0x888888).toString(16).padStart(6, '0');
            ctx.fillStyle = baseCol; ctx.fillRect(0, 0, 512, 512);
            for (let i = 0; i < 8; i++) {
                const opacity = Math.random() * 0.15;
                const brightness = (Math.random() - 0.5) * 60;
                const layerCol = adjustColor(baseCol, brightness);
                ctx.fillStyle = layerCol; ctx.globalAlpha = opacity;
                for (let j = 0; j < 20; j++) {
                    const x = Math.random() * 512; const y = Math.random() * 512;
                    const rx = 80 + Math.random() * 250; const ry = 15 + Math.random() * 50;
                    ctx.beginPath(); ctx.ellipse(x, y, rx, rx/2.5, Math.random() * Math.PI, 0, Math.PI * 2); ctx.fill();
                }
            }
            ctx.globalAlpha = 1.0;
            const tex = new THREE.CanvasTexture(canvas);
            tex.encoding = THREE.sRGBEncoding;
            return tex;
        }

        function adjustColor(color, amount) {
            let col = parseInt(color.replace('#',''), 16);
            let r = (col >> 16) + amount; let g = ((col >> 8) & 0x00FF) + amount; let b = (col & 0x0000FF) + amount;
            r = Math.min(255, Math.max(0, r)); g = Math.min(255, Math.max(0, g)); b = Math.min(255, Math.max(0, b));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }

        function createSaturnRingTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d'); const centerX = 256; const centerY = 256;
            ctx.fillStyle = 'rgba(0,0,0,0)'; ctx.fillRect(0,0,512,512);
            const gradient = ctx.createRadialGradient(centerX, centerY, 100, centerX, centerY, 250);
            gradient.addColorStop(0, 'rgba(0,0,0,0)'); gradient.addColorStop(0.35, 'rgba(220, 210, 190, 0.4)');
            gradient.addColorStop(0.5, 'rgba(220, 210, 190, 0.9)'); gradient.addColorStop(0.55, 'rgba(0,0,0,0.1)');
            gradient.addColorStop(0.6, 'rgba(210, 200, 180, 0.8)'); gradient.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.beginPath(); ctx.arc(centerX, centerY, 250, 0, 2 * Math.PI); ctx.fillStyle = gradient; ctx.fill();
            ctx.strokeStyle = 'rgba(200, 190, 170, 0.1)'; ctx.lineWidth = 1;
            for(let r=120; r<240; r+=3) { ctx.beginPath(); ctx.arc(centerX, centerY, r, 0, 2*Math.PI); ctx.stroke(); }
            return new THREE.CanvasTexture(canvas);
        }

        function createSunGlow() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)'); 
            gradient.addColorStop(0.2, 'rgba(255, 200, 50, 0.6)'); 
            gradient.addColorStop(0.5, 'rgba(255, 150, 0, 0.2)'); 
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            ctx.fillStyle = gradient; ctx.fillRect(0,0,64,64);
            const spriteMaterial = new THREE.SpriteMaterial({ 
                map: new THREE.CanvasTexture(canvas), 
                color: 0xffaa00, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false 
            });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(130, 130, 1); 
            return sprite;
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000005);
            scene.fog = new THREE.FogExp2(0x000005, 0.0012); 

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
            camera.position.set(0, 100, 250);

            try { renderer = new THREE.WebGLRenderer({ antialias: true }); } 
            catch (e) { renderer = new THREE.WebGLRenderer({ antialias: false }); }
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.dampingFactor = 0.05;
            controls.minDistance = 20; controls.maxDistance = 500;

            const hemiLight = new THREE.HemisphereLight( 0xddeeff, 0x0f0e0d, 0.6 );
            scene.add( hemiLight );
            
            const ambient = new THREE.AmbientLight(0xffffff, 0.7); 
            scene.add(ambient);
            
            const sunLight = new THREE.PointLight(0xffffff, 3.5, 0);
            scene.add(sunLight);

            const glow = createSunGlow();
            scene.add(glow);

            createUniverse(); 
            createSolarSystem();
            populateNav(); 

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            window.addEventListener('resize', onWindowResize, false);
            window.addEventListener('click', onMouseClick, false);
            renderer.domElement.addEventListener('touchstart', onTouchStart, false);
            renderer.domElement.addEventListener('touchend', onTouchEnd, false);
            
            animate();
        }

        function populateNav() {
            const nav = document.getElementById('planet-nav');
            planetData.forEach(p => {
                const btn = document.createElement('div');
                btn.className = 'nav-item';
                btn.innerText = p.name;
                btn.onclick = () => selectPlanetByName(p.name);
                nav.appendChild(btn);
            });
        }

        function selectPlanetByName(name) {
            const targetMesh = planets.find(p => p.userData.name === name);
            if (targetMesh) {
                if (isQuizMode) {
                    handleQuizPick(targetMesh.userData);
                } else {
                    if (areOrbitsActive) toggleOrbit();
                    showPopup(targetMesh.userData);
                    controls.target.copy(targetMesh.position);
                }
            }
        }

        function createUniverse() {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            for (let i = 0; i < 4000; i++) vertices.push(THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000), THREE.MathUtils.randFloatSpread(2000));
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            
            const canvas = document.createElement('canvas'); canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)'); gradient.addColorStop(0.4, 'rgba(255, 255, 255, 0.5)'); gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, 32, 32);
            
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 3.5, map: new THREE.CanvasTexture(canvas), transparent: true, blending: THREE.AdditiveBlending, depthWrite: false, opacity: 0.8 });
            const stars = new THREE.Points(geometry, starMaterial);
            scene.add(stars);

            const textureLoader = new THREE.TextureLoader();
            textureLoader.load(
                'stars.jpg',  
                function(texture) {
                    texture.encoding = THREE.sRGBEncoding;
                    addGalaxySphere(texture);
                },
                undefined,
                function(err) {
                     textureLoader.load('Stars.jpg', function(t){
                         t.encoding = THREE.sRGBEncoding;
                         addGalaxySphere(t);
                    });
                }
            );
        }

        function addGalaxySphere(texture) {
            const geometry = new THREE.SphereGeometry(5000, 60, 40);
            const material = new THREE.MeshBasicMaterial({ 
                map: texture, side: THREE.BackSide, depthWrite: false, fog: false 
            });
            const starSphere = new THREE.Mesh(geometry, material);
            scene.add(starSphere);
        }

        function createSolarSystem() {
            const textureLoader = new THREE.TextureLoader();
            const maxAnisotropy = renderer.capabilities.getMaxAnisotropy();
            
            planetData.forEach(data => {
                const geometry = new THREE.SphereGeometry(data.radius, 128, 128);
                let material = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8, metalness: 0.05 });
                const onTexError = () => { material.map = generateOrganicTexture(data); material.needsUpdate = true; };
                
                const tex = textureLoader.load(data.texture, (t) => { 
                    t.encoding = THREE.sRGBEncoding; t.anisotropy = maxAnisotropy; material.map = t; material.needsUpdate = true;
                }, undefined, onTexError);
                
                if (data.name === "Slnko") { material = new THREE.MeshBasicMaterial({ color: 0xffffff, map: tex }); }

                const mesh = new THREE.Mesh(geometry, material);
                mesh.userData = { ...data, angle: Math.random() * Math.PI * 2 }; 
                
                if (data.distance3D === 0) {
                     mesh.position.set(0,0,0);
                } else {
                    mesh.position.x = Math.cos(mesh.userData.angle) * data.distance3D;
                    mesh.position.z = Math.sin(mesh.userData.angle) * data.distance3D;
                }

                scene.add(mesh);
                planets.push(mesh);

                // SATELLITES (MOONS) LOGIC
                if (data.moons) {
                    data.moons.forEach(moonData => {
                        const mGeo = new THREE.SphereGeometry(moonData.radius, 32, 32);
                        let mMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.8 });
                        // Load moon texture
                        textureLoader.load(moonData.texture, (t) => { 
                            t.encoding = THREE.sRGBEncoding; mMat.map = t; mMat.needsUpdate = true;
                        }, undefined, () => { mMat.map = generateOrganicTexture({color: 0x888888}); mMat.needsUpdate = true; });

                        const moonMesh = new THREE.Mesh(mGeo, mMat);
                        moonMesh.userData = { 
                            ...moonData, 
                            angle: Math.random() * Math.PI * 2,
                            parent: mesh 
                        };
                        scene.add(moonMesh);
                        satellites.push(moonMesh);
                    });
                }

                if (data.hasRings) {
                    const ringGeo = new THREE.PlaneGeometry(data.radius * 4.5, data.radius * 4.5);
                    const ringMat = new THREE.MeshBasicMaterial({ map: createSaturnRingTexture(), side: THREE.DoubleSide, transparent: true, depthWrite: false });
                    const ring = new THREE.Mesh(ringGeo, ringMat);
                    ring.rotation.x = -Math.PI / 2.5; mesh.add(ring);
                }

                if (data.distance3D > 0) {
                    const orbitCurve = new THREE.EllipseCurve(0, 0, data.distance3D, data.distance3D, 0, 2 * Math.PI, false, 0);
                    const orbitLine = new THREE.Line(new THREE.BufferGeometry().setFromPoints(orbitCurve.getPoints(128)), new THREE.LineBasicMaterial({ color: 0x444444, transparent: true, opacity: 0.3 }));
                    orbitLine.rotation.x = Math.PI / 2;
                    scene.add(orbitLine);
                }
            });
        }

        function toggleOrbit() {
            areOrbitsActive = !areOrbitsActive;
            const btn = document.getElementById('pause-btn');
            if (areOrbitsActive) {
                btn.innerText = "Orbity: ZAPNUTÉ";
                btn.classList.remove('active');
            } else {
                btn.innerText = "Orbity: POZASTAVENÉ";
                btn.classList.add('active');
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // PLANETS
            planets.forEach(mesh => {
                const data = mesh.userData;
                const spinSpeed = data.name === "Slnko" ? 0.002 : 0.004;
                mesh.rotation.y += spinSpeed;

                if (areOrbitsActive && !isQuizMode && data.distance3D > 0) {
                    mesh.userData.angle -= data.speed * 0.2; 
                    mesh.position.x = Math.cos(mesh.userData.angle) * data.distance3D;
                    mesh.position.z = Math.sin(mesh.userData.angle) * data.distance3D;
                }
            });

            // SATELLITES (MOONS)
            satellites.forEach(moon => {
                const data = moon.userData;
                const parent = data.parent;
                
                // Moon rotation on axis
                moon.rotation.y += 0.01;

                if (areOrbitsActive && !isQuizMode) {
                    data.angle -= data.speed * 0.5; // Moons orbit faster
                }
                
                // Update Moon position relative to Parent Planet
                // Logic: ParentPos + (cos(angle)*dist, 0, sin(angle)*dist)
                moon.position.x = parent.position.x + Math.cos(data.angle) * data.distance;
                moon.position.z = parent.position.z + Math.sin(data.angle) * data.distance;
                moon.position.y = parent.position.y; // Keep level with planet
            });
            
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function resetCamera() { controls.target.set(0, 0, 0); camera.position.set(0, 100, 250); closePopup(); }

        function onTouchStart(e) {
            touchStartX = e.changedTouches[0].clientX;
            touchStartY = e.changedTouches[0].clientY;
        }

        function onTouchEnd(e) {
            const dx = e.changedTouches[0].clientX - touchStartX;
            const dy = e.changedTouches[0].clientY - touchStartY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 20) {
                e.preventDefault(); 
                checkIntersection(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
            }
        }

        function onMouseClick(e) {
            checkIntersection(e.clientX, e.clientY);
        }

        function checkIntersection(x, y) {
            const el = document.elementFromPoint(x, y);
            if (el && (el.closest('#side-ui') || el.closest('#info-card') || el.closest('#quiz-overlay') || el.closest('#results-screen') || el.closest('#planet-nav'))) return;
            
            if (isWaiting) return;

            mouse.x = (x / window.innerWidth) * 2 - 1;
            mouse.y = -(y / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects([...planets, ...satellites]); // Check moons too!
            
            if (intersects.length > 0) {
                const target = intersects[0].object;
                
                // If user clicks a moon, focus on parent for now (simplifies UI)
                const data = target.userData.parent ? target.userData.parent.userData : target.userData;
                const pos = target.userData.parent ? target.userData.parent.position : target.position;

                if (isQuizMode) handleQuizPick(data);
                else { 
                    if (areOrbitsActive) toggleOrbit(); 
                    showPopup(data); 
                    controls.target.copy(pos); 
                }
            }
        }

        function showPopup(data) {
            document.getElementById('planet-name').innerText = data.name;
            document.getElementById('planet-dist').innerText = data.realDist;
            document.getElementById('planet-diam').innerText = data.realDiam;
            document.getElementById('planet-orbit').innerText = data.orbit;
            document.getElementById('planet-rotate').innerText = data.rotation;
            document.getElementById('planet-fact').innerText = data.fact;
            document.getElementById('info-card').style.display = 'block';
        }

        function closePopup() { document.getElementById('info-card').style.display = 'none'; }

        function startQuiz() {
            isQuizMode = true; score = 0; quizIndex = 0;
            if (areOrbitsActive) toggleOrbit();
            quizQueue = planetData.filter(p => p.name !== "Slnko").sort(() => Math.random() - 0.5);
            document.getElementById('quiz-overlay').style.display = 'block';
            document.getElementById('side-ui').style.visibility = 'hidden';
            nextQuestion();
        }

        function nextQuestion() {
            if (quizIndex >= quizQueue.length) { finishQuiz(); return; }
            quizTarget = quizQueue[quizIndex]; isWaiting = false;
            document.getElementById('quiz-question').innerText = `Nájdi planétu: ${quizTarget.fact}`;
            document.getElementById('quiz-feedback').innerText = "";
            updateQuizDisplay();
        }

        function handleQuizPick(pick) {
            if (isWaiting) return;
            isWaiting = true;
            const feed = document.getElementById('quiz-feedback');
            if (pick.name === quizTarget.name) {
                score++;
                feed.innerHTML = `<span style="color:#00ff00">Správne!</span>`;
                updateQuizDisplay();
                setTimeout(() => { quizIndex++; nextQuestion(); }, 1000);
            } else {
                feed.innerHTML = `<span style="color:#ff4444">Nesprávne!</span> Bola to: ${quizTarget.name}`;
                setTimeout(() => { quizIndex++; nextQuestion(); }, 2000);
            }
        }

        function updateQuizDisplay() {
            document.getElementById('quiz-score').innerText = `Otázka: ${quizIndex + 1} / 8 | Skóre: ${score}`;
        }

        function finishQuiz() {
            document.getElementById('quiz-overlay').style.display = 'none';
            document.getElementById('results-screen').style.display = 'flex';
            document.getElementById('final-score').innerText = `${score} / 8`;
            document.getElementById('grade-comment').innerText = score === 8 ? "Excelentné! Si pán vesmíru." : "Dobrá práca, skús to znova!";
        }

        function stopQuiz() {
            isQuizMode = false;
            isWaiting = false;
            document.getElementById('quiz-overlay').style.display = 'none';
            document.getElementById('results-screen').style.display = 'none';
            document.getElementById('side-ui').style.visibility = 'visible';
            resetCamera();
        }
    </script>
</body>
</html>
